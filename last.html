<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบจองสนาม</title>
    <!-- jquery -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

    <!-- Tailwind css -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <!-- Loading Overlay -->
    <script src="https://cdn.jsdelivr.net/npm/gasparesganga-jquery-loading-overlay@2.1.7/dist/loadingoverlay.min.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .animate-fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .loading-content {
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            min-width: 250px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-center">
                <i class="fas fa-calendar-alt mr-3"></i>ระบบจองสนาม
            </h1>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div id="fieldSelection" class="max-w-6xl mx-auto">
            <div class="bg-white rounded-xl card-shadow p-8 animate-fade-in">
                <h2 class="text-3xl font-bold text-gray-800 mb-2 text-center">
                    <i class="fas fa-futbol text-green-600 mr-3"></i>เลือกประเภทสนาม
                </h2>
                <p class="text-gray-600 text-center mb-8">กรุณาเลือกประเภทสนามที่ต้องการจอง</p>
                
                <div class="grid md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- Updated Field Card: สนามกีฬา A -->
                    <div class="field-card bg-gradient-to-br from-green-400 to-green-600 rounded-xl p-6 text-white cursor-pointer transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl" data-field="สนามกีฬา A">
                        <div class="text-center">
                            <div class="mb-4">
                                <img src="https://cdn-icons-png.flaticon.com/512/1259/1259792.png" alt="สนามกีฬา A" class="w-16 h-16 mx-auto">
                            </div>
                            <h3 class="text-xl font-bold mb-2">สนามกีฬา A</h3>
                            <p class="text-green-100 text-sm">สามารถใช้สำหรับการเล่นกีฬา ได้แก่ ฟุตซอล แชร์บอล บาสเกตบอล และวอลเลย์บอล</p>
                            <div class="mt-4 bg-white bg-opacity-20 rounded-lg p-2">
                                <span class="text-sm">จองสนาม</span>
                            </div>
                        </div>
                    </div>
                    <!-- Updated Field Card: สนามกีฬา B -->
                    <div class="field-card bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl p-6 text-white cursor-pointer transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl" data-field="สนามกีฬา B">
                        <div class="text-center">
                            <div class="mb-4">
                                <img src="https://cdn-icons-png.flaticon.com/512/1259/1259792.png" alt="สนามกีฬา B" class="w-16 h-16 mx-auto">
                            </div>
                            <h3 class="text-xl font-bold mb-2">สนามกีฬา B</h3>
                            <p class="text-blue-100 text-sm">สามารถใช้สำหรับการเล่นกีฬา ได้แก่ เทเบิลเทนนิส ตะกร้อ และแบดมินตัน</p>
                            <div class="mt-4 bg-white bg-opacity-20 rounded-lg p-2">
                                <span class="text-sm">จองสนาม</span>
                            </div>
                        </div>
                    </div>
                    <!-- Updated Field Card: สนามฟุตบอล -->
                    <div class="field-card bg-gradient-to-br from-orange-400 to-orange-600 rounded-xl p-6 text-white cursor-pointer transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl" data-field="สนามฟุตบอล">
                        <div class="text-center">
                            <div class="mb-4">
                                <img src="https://cdn-icons-png.flaticon.com/512/1259/1259792.png" alt="สนามฟุตบอล" class="w-16 h-16 mx-auto">
                            </div>
                            <h3 class="text-xl font-bold mb-2">สนามฟุตบอล</h3>
                            <p class="text-orange-100 text-sm">สนามสามารถรองรับการแข่งขันฟุตบอลแบบทีม 11 คนเต็มรูปแบบ</p>
                            <div class="mt-4 bg-white bg-opacity-20 rounded-lg p-2">
                                <span class="text-sm">จองสนาม</span>
                            </div>
                        </div>
                    </div>
                    <!-- Updated Field Card: ห้องซ้อมเต้น -->
                    <div class="field-card bg-gradient-to-br from-purple-400 to-purple-600 rounded-xl p-6 text-white cursor-pointer transform hover:scale-105 transition-all duration-300 shadow-lg hover:shadow-xl" data-field="ห้องซ้อมเต้น">
                        <div class="text-center">
                            <div class="mb-4">
                                <img src="https://cdn-icons-png.flaticon.com/512/1259/1259792.png" alt="ห้องซ้อมเต้น" class="w-16 h-16 mx-auto">
                            </div>
                            <h3 class="text-xl font-bold mb-2">ห้องซ้อมเต้น</h3>
                            <p class="text-purple-100 text-sm">ห้องมีพื้นที่กว้างขวาง สามารถรองรับผู้ใช้งานได้ประมาณ 10–15 คน</p>
                            <div class="mt-4 bg-white bg-opacity-20 rounded-lg p-2">
                                <span class="text-sm">จองสนาม</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="bookingForm" class="max-w-4xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8 animate-fade-in">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">
                        <i class="fas fa-edit text-blue-600 mr-2"></i>แบบฟอร์มจอง
                    </h2>
                    <button id="backToSelection" class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>เลือกใหม่
                    </button>
                </div>
                
                <div id="selectedFieldInfo" class="bg-gray-50 p-4 rounded-lg mb-6">
                </div>
                
                <form id="reservationForm" class="space-y-6">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-user text-blue-600 mr-2"></i>ชื่อ-สกุล *
                            </label>
                            <input type="text" id="fullName" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-phone text-green-600 mr-2"></i>เบอร์โทรศัพท์ *
                            </label>
                            <input type="tel" id="phone" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-calendar text-purple-600 mr-2"></i>วันที่จอง (เริ่มต้น) *
                            </label>
                            <input type="date" id="bookingStartDate" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-calendar-check text-purple-600 mr-2"></i>วันที่จอง (สิ้นสุด) *
                            </label>
                            <input type="date" id="bookingEndDate" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                        </div>

                        <div class="col-span-2">
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-clock text-orange-600 mr-2"></i>เลือกช่วงเวลา *
                            </label>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-orange-50 cursor-pointer transition-colors has-[:checked]:border-orange-500 has-[:checked]:bg-orange-100">
                                    <input type="radio" name="bookingTime" value="08:00-12:00" class="mr-3 text-orange-600" required>
                                    <span>08:00 น. - 12:00 น.</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-orange-50 cursor-pointer transition-colors has-[:checked]:border-orange-500 has-[:checked]:bg-orange-100">
                                    <input type="radio" name="bookingTime" value="13:00-16:30" class="mr-3 text-orange-600">
                                    <span>13:00 น. - 16:30 น.</span>
                                </label>
                                <label class="flex items-center p-3 border border-gray-300 rounded-lg hover:bg-orange-50 cursor-pointer transition-colors has-[:checked]:border-orange-500 has-[:checked]:bg-orange-100">
                                    <input type="radio" name="bookingTime" value="08:00-16:30" class="mr-3 text-orange-600">
                                    <span>08:00 น. - 16:30 น.</span>
                                </label>
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-id-badge text-indigo-600 mr-2"></i>สถานะ *
                            </label>
                            <select id="status" required 
                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                                <option value="">-- เลือกสถานะ --</option>
                                <option value="นักศึกษา">นักศึกษา</option>
                                <option value="อาจารย์">อาจารย์</option>
                                <option value="บุคคลภายนอก">บุคคลภายนอก</option>
                            </select>
                        </div>
                    </div>

                    <!-- Payment Slip Section (For บุคคลภายนอก) -->
                    <div id="paymentSlipSection" class="hidden">
                        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                                </div>
                                <div class="ml-3">
                                    <p class="text-sm text-yellow-700">
                                        <strong>สำหรับบุคคลภายนอก:</strong> กรุณาชำระเงินและอัปโหลดสลิปการโอนเงิน
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-lg mb-4">
                            <h4 class="font-bold text-blue-800 mb-3">ข้อมูลการโอนเงิน</h4>
                            <div class="grid md:grid-cols-2 gap-4">
                                <div class="text-sm text-blue-700 space-y-1">
                                    <p><strong>ธนาคาร:</strong> ธนาคารกรุงไทย</p>
                                    <p><strong>เลขที่บัญชี:</strong> 123-4-56789-0</p>
                                    <p><strong>ชื่อบัญชี:</strong> มหาวิทยาลัยตัวอย่าง</p>
                                    <p id="paymentAmount"><strong>จำนวนเงิน:</strong> 0 บาท</p>
                                </div>
                                <div class="text-center">
                                    <p class="text-sm font-bold text-blue-800 mb-2">สแกน QR Code PromptPay</p>
                                    <img id="promptPayQR" src="https://promptpay.io/0836712486/6000.png" alt="QR Code PromptPay" class="w-32 h-32 mx-auto border-2 border-blue-200 rounded-lg shadow-md">
                                    <p class="text-xs text-blue-600 mt-1">083-671-2486</p>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-upload text-green-600 mr-2"></i>อัปโหลดสลิปการโอนเงิน *
                            </label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                                <input type="file" id="paymentSlip" accept="image/*" class="hidden">
                                <label for="paymentSlip" class="cursor-pointer">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3 block"></i>
                                    <p class="text-gray-600">คลิกเพื่อเลือกไฟล์สลิป</p>
                                    <p class="text-sm text-gray-400 mt-1">รองรับไฟล์ JPG, PNG</p>
                                </label>
                            </div>
                            <div id="filePreviewPayment" class="mt-4 hidden">
                                <img id="previewImagePayment" class="max-w-xs mx-auto rounded-lg shadow-md">
                                <p id="fileNamePayment" class="text-center text-gray-600 mt-2"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Approval File Section (For นักศึกษา & อาจารย์) -->
                    <div id="approvalFileSection" class="hidden">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">
                                <i class="fas fa-file-upload text-blue-600 mr-2"></i>บันทึกข้อความ ขออนุมัติจัดกิจกรรมและใช้สถานที่ *
                            </label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors">
                                <input type="file" id="approvalFile" accept="image/*, .pdf" class="hidden">
                                <label for="approvalFile" class="cursor-pointer">
                                    <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3 block"></i>
                                    <p class="text-gray-600">คลิกเพื่อเลือกไฟล์เอกสาร (PDF หรือรูปภาพ)</p>
                                    <p class="text-sm text-gray-400 mt-1">รองรับไฟล์ JPG, PNG, PDF</p>
                                </label>
                            </div>
                            <div id="filePreviewApproval" class="mt-4 hidden">
                                <div id="previewContainerApproval" class="max-w-xs mx-auto rounded-lg shadow-md border-2 border-gray-200 p-2">
                                    <!-- Preview content will be injected here -->
                                </div>
                                <p id="fileNameApproval" class="text-center text-gray-600 mt-2"></p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <i class="fas fa-basketball-ball text-orange-600 mr-2"></i>อุปกรณ์กีฬา
                        </label>
                        <div id="equipmentOptions" class="grid md:grid-cols-3 gap-3">
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-3">
                            <i class="fas fa-users text-purple-600 mr-2"></i>เจ้าหน้าที่และคณะกรรมการ
                        </label>
                        <div class="grid md:grid-cols-2 gap-3">
                            <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-purple-50 cursor-pointer transition-all">
                                <input type="checkbox" name="staff" value="เจ้าหน้าที่ดูแลสถานที่" class="mr-3 text-purple-600">
                                <span>👨‍💼 เจ้าหน้าที่ดูแลสถานที่</span>
                            </label>
                            <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-purple-50 cursor-pointer transition-all">
                                <input type="checkbox" name="staff" value="กรรมการตัดสินกีฬา" class="mr-3 text-purple-600">
                                <span>👨‍⚖️ กรรมการตัดสินกีฬา</span>
                            </label>
                            <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-purple-50 cursor-pointer transition-all">
                                <input type="checkbox" name="staff" value="เจ้าหน้าที่เครื่องเสียง" class="mr-3 text-purple-600">
                                <span>🎵 เจ้าหน้าที่เครื่องเสียง</span>
                            </label>
                            <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-purple-50 cursor-pointer transition-all">
                                <input type="checkbox" name="staff" value="แม่บ้านทำความสะอาด" class="mr-3 text-purple-600">
                                <span>🧹 แม่บ้านทำความสะอาด</span>
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 font-medium mb-2">
                            <i class="fas fa-sticky-note text-yellow-600 mr-2"></i>หมายเหตุ (ถ้ามี)
                        </label>
                        <textarea id="notes" rows="3" 
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                            placeholder="ระบุข้อมูลเพิ่มเติม..."></textarea>
                    </div>

                    <div class="text-center pt-4">
                        <button type="submit" 
                            class="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-8 py-4 rounded-lg font-medium text-lg hover:from-blue-700 hover:to-purple-700 transform hover:scale-105 transition-all duration-200 shadow-lg">
                            <i class="fas fa-paper-plane mr-2"></i>ส่งคำขอจอง
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div id="successPage" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8 text-center animate-fade-in">
                <div class="mb-6">
                    <i class="fas fa-check-circle text-6xl text-green-500 mb-4"></i>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">จองสำเร็จ!</h2>
                    <p class="text-gray-600">ระบบได้บันทึกข้อมูลการจองของคุณเรียบร้อยแล้ว</p>
                </div>
                
                <div id="bookingSummary" class="bg-gray-50 p-6 rounded-lg mb-6 text-left">
                </div>
            </div>
        </div>
    </div>

    <!-- Sweet Alert -->
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        // Global variables
        let bookingData = {};
        let selectedField = '';
        let existingBookings = [];
        const API_CHECK_URL = 'https://opensheet.elk.sh/1xxx/data';
        const API_SUBMIT_URL = 'https://script.google.com/macros/s/xxx/exec';

        // Field data
        const fieldData = {
            'สนามกีฬา A': {
                icon: 'https://cdn-icons-png.flaticon.com/512/1259/1259792.png',
                name: 'สนามกีฬา A',
                description: 'สามารถใช้สำหรับการเล่นกีฬา ได้แก่ ฟุตซอล แชร์บอล บาสเกตบอล และวอลเลย์บอล',
                price: 6000,
                equipment: ['ลูกฟุตซอล', 'ลูกแชร์บอล', 'ลูกบาสเกตบอล', 'ลูกวอลเลย์บอล', 'เน็ตวอลเลย์บอล', 'กรวยจราจร', 'เสื้อกั๊ก']
            },
            'สนามกีฬา B': {
                icon: 'https://cdn-icons-png.flaticon.com/512/1259/1259792.png',
                name: 'สนามกีฬา B',
                description: 'สามารถใช้สำหรับการเล่นกีฬา ได้แก่ เทเบิลเทนนิส ตะกร้อ และแบดมินตัน',
                price: 6000,
                equipment: ['ไม้เทเบิลเทนนิส', 'ลูกเทเบิลเทนนิส', 'ลูกตะกร้อ', 'ไม้แบดมินตัน', 'ลูกขนไก่']
            },
            'สนามฟุตบอล': {
                icon: 'https://cdn-icons-png.flaticon.com/512/1259/1259792.png',
                name: 'สนามฟุตบอล',
                description: 'สนามสามารถรองรับการแข่งขันฟุตบอลแบบทีม 11 คนเต็มรูปแบบ',
                price: 6000,
                equipment: ['ลูกฟุตบอล', 'กรวยจราจร', 'เสื้อกั๊ก']
            },
            'ห้องซ้อมเต้น': {
                icon: 'https://cdn-icons-png.flaticon.com/512/1259/1259792.png',
                name: 'ห้องซ้อมเต้น',
                description: 'ห้องมีพื้นที่กว้างขวาง สามารถรองรับผู้ใช้งานได้ประมาณ 10–15 คน',
                price: 4000,
                equipment: ['ลำโพง', 'สาย AUX', 'ไมโครโฟน']
            }
        };

        const timeSlots = {
            '08:00-12:00': { start: '08:00', end: '12:00', hours: 4, label: '08:00 น. - 12:00 น.' },
            '13:00-16:30': { start: '13:00', end: '16:30', hours: 3.5, label: '13:00 น. - 16:30 น.' },
            '08:00-16:30': { start: '08:00', end: '16:30', hours: 8.5, label: '08:00 น. - 16:30 น.' }
        };

        // Fetch existing booking data
        async function fetchBookings() {
            $('body').LoadingOverlay('show', {
                image: '',
                custom: $('<div class="loading-content"><i class="fas fa-spinner fa-spin text-4xl text-white mb-4"></i><div class="text-white text-lg font-medium">กำลังโหลดข้อมูลการจอง...</div></div>'),
                background: 'rgba(0, 0, 0, 0.8)',
                zIndex: 9999
            });
            try {
                const response = await fetch(API_CHECK_URL);
                if (!response.ok) {
                    throw new Error('Failed to fetch booking data.');
                }
                const data = await response.json();
                existingBookings = data;
            } catch (error) {
                console.error('Error fetching booking data:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาดในการโหลดข้อมูล',
                    text: 'ไม่สามารถโหลดข้อมูลการจองปัจจุบันได้ กรุณาลองใหม่อีกครั้ง'
                });
            } finally {
                $('body').LoadingOverlay('hide');
            }
        }
        
        // Helper function to format date for display
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            return date.toLocaleDateString('th-TH', options);
        }
        
        // Helper function to parse HH:MM to a number (e.g., 8:00 -> 8, 16:30 -> 16.5)
        function parseTime(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours + minutes / 60;
        }

        // Check for booking conflicts
        function checkAvailability() {
            const startDateStr = $('#bookingStartDate').val();
            const endDateStr = $('#bookingEndDate').val();
            const selectedTimeSlot = $('input[name="bookingTime"]:checked').val();
            const fieldType = selectedField;

            if (!startDateStr || !endDateStr || !selectedTimeSlot || !fieldType) {
                return true;
            }

            const selectedStartDate = new Date(startDateStr);
            const selectedEndDate = new Date(endDateStr);
            const selectedFieldTimeLabel = timeSlots[selectedTimeSlot].label;
            const selectedTimeStart = parseTime(timeSlots[selectedTimeSlot].start);
            const selectedTimeEnd = parseTime(timeSlots[selectedTimeSlot].end);

            for (const booking of existingBookings) {
                const bookedStartDate = new Date(booking['วันที่จอง']);
                const bookedEndDate = new Date(booking['วันที่สิ้นสุด']);
                const bookedTimeSlotLabel = booking['เวลาสิ้นสุด'].trim();
                const bookedFieldType = booking['ประเภทสนาม'].trim();

                const hasDateOverlap = (selectedStartDate <= bookedEndDate && selectedEndDate >= bookedStartDate);
                
                if (hasDateOverlap) {
                    const bookedTimeSlotKey = Object.keys(timeSlots).find(key => timeSlots[key].label === bookedTimeSlotLabel);
                    if (bookedTimeSlotKey) {
                        const bookedTimeStart = parseTime(timeSlots[bookedTimeSlotKey].start);
                        const bookedTimeEnd = parseTime(timeSlots[bookedTimeSlotKey].end);

                        // Check for time range overlap: [A, B] overlaps with [C, D] if A < D and C < B
                        const hasTimeOverlap = (selectedTimeStart < bookedTimeEnd && bookedTimeStart < selectedTimeEnd);

                        if (hasTimeOverlap) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'วันที่จองไม่ว่าง',
                                html: `
                                    <div class="text-left leading-relaxed">
                                        <p class="text-gray-700">การจองปฏิทิน: การจองสำหรับ <strong>${bookedFieldType}</strong> ในวันที่ <strong>${formatDate(startDateStr)}</strong> ช่วงเวลา <strong>${bookedTimeSlotLabel}</strong> ถูกจองแล้ว</p>
                                    </div>
                                `
                            });
                            return false;
                        }
                    }
                }
            }
            return true;
        }

        // Initialize
        $(document).ready(function() {
            // Fetch bookings on page load
            fetchBookings();

            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            $('#bookingStartDate').attr('min', today);
            $('#bookingEndDate').attr('min', today);

            // Field selection handlers
            $('.field-card').click(function() {
                selectedField = $(this).data('field');
                showBookingForm();
            });

            // Back to selection
            $('#backToSelection').click(function() {
                $('#bookingForm').addClass('hidden');
                $('#fieldSelection').removeClass('hidden');
                resetForm();
            });

            // Status change handler
            $('#status').change(function() {
                const status = $(this).val();
                $('#paymentSlipSection').addClass('hidden');
                $('#approvalFileSection').addClass('hidden');
                $('#paymentSlip').attr('required', false);
                $('#approvalFile').attr('required', false);
                
                if (status === 'บุคคลภายนอก') {
                    $('#paymentSlipSection').removeClass('hidden');
                    $('#paymentSlip').attr('required', true);
                } else if (status === 'นักศึกษา' || status === 'อาจารย์') {
                    $('#approvalFileSection').removeClass('hidden');
                    $('#approvalFile').attr('required', true);
                }
                updatePaymentAmount();
            });
            
            // File upload preview for payment slip
            $('#paymentSlip').change(function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        $('#previewImagePayment').attr('src', e.target.result);
                        $('#fileNamePayment').text(file.name);
                        $('#filePreviewPayment').removeClass('hidden');
                    };
                    reader.readAsDataURL(file);
                }
            });

            // File upload preview for approval file
            $('#approvalFile').change(function(e) {
                const file = e.target.files[0];
                const previewContainer = $('#previewContainerApproval');
                const fileNameDisplay = $('#fileNameApproval');
                
                previewContainer.empty();
                if (file) {
                    fileNameDisplay.text(file.name);
                    $('#filePreviewApproval').removeClass('hidden');

                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            previewContainer.html(`<img src="${e.target.result}" class="w-full h-auto rounded-lg">`);
                        };
                        reader.readAsDataURL(file);
                    } else if (file.type === 'application/pdf') {
                         previewContainer.html(`<div class="flex items-center justify-center h-full py-10 text-gray-500">
                             <i class="fas fa-file-pdf text-4xl mr-2"></i>
                             <span>ไฟล์ PDF</span>
                         </div>`);
                    }
                } else {
                    $('#filePreviewApproval').addClass('hidden');
                }
            });

            // Date and time slot change handlers for payment calculation and availability
            $('#bookingStartDate, #bookingEndDate, input[name="bookingTime"]').change(function() {
                updatePaymentAmount();
                checkAvailability();
            });
        });

        // Show booking form with selected field info
        function showBookingForm() {
            const field = fieldData[selectedField];
            
            // Update selected field info
            $('#selectedFieldInfo').html(`
                <div class="flex items-center">
                    <div class="text-3xl mr-4">
                        <img src="${field.icon}" alt="${field.name}" class="w-16 h-16">
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-800">${field.name}</h3>
                        <p class="text-gray-600">${field.description}</p>
                        <p class="text-blue-600 font-medium">${field.price.toLocaleString()} บาท/ชั่วโมง</p>
                    </div>
                </div>
            `);

            // Update equipment options
            const equipmentHtml = field.equipment.map(item => `
                <label class="flex items-center p-3 border border-gray-200 rounded-lg hover:bg-blue-50 cursor-pointer transition-all">
                    <input type="checkbox" name="equipment" value="${item}" class="mr-3 text-blue-600">
                    <span>${getEquipmentIcon(item)} ${item}</span>
                </label>
            `).join('');
            $('#equipmentOptions').html(equipmentHtml);

            // Show form and hide selection
            $('#fieldSelection').addClass('hidden');
            $('#bookingForm').removeClass('hidden');
        }

        // Get equipment icon
        function getEquipmentIcon(equipment) {
            const icons = {
                'ลูกฟุตซอล': '⚽',
                'ลูกแชร์บอล': '🏐',
                'ลูกบาสเกตบอล': '🏀',
                'ลูกวอลเลย์บอล': '🏐',
                'ลูกเทเบิลเทนนิส': '🏓',
                'ลูกตะกร้อ': '🪀',
                'ลูกขนไก่': '🏸',
                'ลูกฟุตบอล': '⚽',
                'กรวยจราจร': '🚧',
                'เสื้อกั๊ก': '👕',
                'เน็ตวอลเลย์บอล': '🥅',
                'ไม้เทเบิลเทนนิส': '🏓',
                'ไม้แบดมินตัน': '🏸',
                'ปั๊มลม': '🔧',
                'ลำโพง': '🔊',
                'สาย AUX': '🎧',
                'ไมโครโฟน': '🎤'
            };
            return icons[equipment] || '🏃‍♂️';
        }

        // Update payment amount based on time duration and number of days
        function updatePaymentAmount() {
            const startDate = $('#bookingStartDate').val();
            const endDate = $('#bookingEndDate').val();
            const selectedTimeSlot = $('input[name="bookingTime"]:checked').val();
            
            if (startDate && endDate && selectedTimeSlot && selectedField) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffDays = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

                if (diffDays > 0) {
                    const pricePerHour = fieldData[selectedField].price;
                    const hours = timeSlots[selectedTimeSlot].hours;
                    const totalAmount = pricePerHour * hours * diffDays;

                    $('#paymentAmount').html(`<strong>จำนวนเงิน:</strong> ${totalAmount.toLocaleString()} บาท`);
                    $('#promptPayQR').attr('src', `https://promptpay.io/0836712486/${totalAmount}.png`);
                }
            }
        }

        // Reset form
        function resetForm() {
            $('#reservationForm')[0].reset();
            $('#paymentSlipSection').addClass('hidden');
            $('#approvalFileSection').addClass('hidden');
            $('#filePreviewPayment').addClass('hidden');
            $('#filePreviewApproval').addClass('hidden');
            selectedField = '';
            $('#paymentAmount').html('<strong>จำนวนเงิน:</strong> 0 บาท');
        }

        // Handle booking form submission
        $('#reservationForm').submit(function(e) {
            e.preventDefault();
            
            const startDate = $('#bookingStartDate').val();
            const endDate = $('#bookingEndDate').val();
            const selectedTimeSlot = $('input[name="bookingTime"]:checked').val();
            const status = $('#status').val();

            if (new Date(startDate) > new Date(endDate)) {
                Swal.fire({
                    icon: 'error',
                    title: 'วันที่ไม่ถูกต้อง',
                    text: 'วันที่เริ่มต้นต้องน้อยกว่าหรือเท่ากับวันที่สิ้นสุด'
                });
                return;
            }

            if (!selectedTimeSlot) {
                Swal.fire({
                    icon: 'error',
                    title: 'เวลาไม่ถูกต้อง',
                    text: 'กรุณาเลือกช่วงเวลาที่ต้องการจอง'
                });
                return;
            }

            // Perform final availability check before submission
            if (!checkAvailability()) {
                return;
            }

            bookingData = {
                fullName: $('#fullName').val(),
                phone: $('#phone').val(),
                bookingStartDate: startDate,
                bookingEndDate: endDate,
                timeSlot: selectedTimeSlot,
                fieldType: selectedField,
                status: status,
                equipment: $('input[name="equipment"]:checked').map(function() { return this.value; }).get(),
                staff: $('input[name="staff"]:checked').map(function() { return this.value; }).get(),
                notes: $('#notes').val()
            };

            let fileToUpload = null;
            let fileInputId = '';
            
            if (status === 'บุคคลภายนอก') {
                fileInputId = 'paymentSlip';
            } else if (status === 'นักศึกษา' || status === 'อาจารย์') {
                fileInputId = 'approvalFile';
            }

            if (fileInputId) {
                const fileInput = $(`#${fileInputId}`)[0];
                if (!fileInput.files[0]) {
                    Swal.fire({
                        icon: 'error',
                        title: 'กรุณาอัปโหลดไฟล์',
                        text: 'กรุณาเลือกไฟล์ที่จำเป็นสำหรับการจอง'
                    });
                    return;
                }
                fileToUpload = fileInput.files[0];

                const reader = new FileReader();
                reader.onload = function(e) {
                    bookingData.file = {
                        data: e.target.result.split(',')[1],
                        name: fileToUpload.name,
                        mimeType: fileToUpload.type,
                        type: fileInputId // paymentSlip or approvalFile
                    };
                    submitBooking();
                };
                reader.readAsDataURL(fileToUpload);
            } else {
                submitBooking();
            }
        });

        // Submit booking to Google Apps Script
        function submitBooking() {
            $('body').LoadingOverlay('show', {
                image: '',
                custom: $('<div class="loading-content"><i class="fas fa-spinner fa-spin text-4xl text-white mb-4"></i><div class="text-white text-lg font-medium">กำลังบันทึกข้อมูล...</div><div class="text-white text-sm opacity-80 mt-2">กรุณารอสักครู่</div></div>'),
                background: 'rgba(0, 0, 0, 0.8)',
                zIndex: 9999
            });

            const submitData = new URLSearchParams();
            Object.keys(bookingData).forEach(key => {
                if (key === 'equipment' || key === 'staff') {
                    submitData.append(key, bookingData[key].join(', '));
                } else if (key === 'file') {
                    submitData.append('fileData', bookingData[key].data);
                    submitData.append('fileName', bookingData[key].name);
                    submitData.append('fileMimeType', bookingData[key].mimeType);
                    submitData.append('fileType', bookingData[key].type);
                } else {
                    submitData.append(key, bookingData[key]);
                }
            });

            fetch(API_SUBMIT_URL, {
                method: 'POST',
                body: submitData
            })
            .then(response => {
                // Check if the response is OK.
                if (!response.ok) {
                    // If not OK, read the server's plain text error message.
                    return response.text().then(text => {
                        // Throw a new Error with the server's message.
                        throw new Error(text);
                    });
                }
                // If OK, parse the response as JSON.
                return response.json();
            })
            .then(data => {
                $('body').LoadingOverlay('hide');
                
                if (data.success) {
                    $('#bookingForm').addClass('hidden');
                    showSuccessPage();
                    
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 }
                    });
                } else {
                    // Handle cases where the server returns a 200 OK but with a success: false payload
                    throw new Error(data.message || 'เกิดข้อผิดพลาดที่ไม่ระบุ');
                }
            })
            .catch(error => {
                $('body').LoadingOverlay('hide');
                console.error('Error:', error);
                
                // Use the error message from the re-thrown error
                let errorMessage = error.message;
                try {
                    // Parse the error message to get the relevant part
                    const fullErrorText = error.message;
                    const errorPrefix = 'Error: ';
                    if (fullErrorText.startsWith(errorPrefix)) {
                        errorMessage = fullErrorText.substring(errorPrefix.length);
                    }
                } catch (e) {
                    console.error('Failed to parse error message:', e);
                }
                
                Swal.fire({
                    icon: 'error',
                    title: 'เกิดข้อผิดพลาด',
                    text: errorMessage
                });
            });
        }

        // Show success page with booking summary
        function showSuccessPage() {
            const formatDateRange = (startDateStr, endDateStr) => {
                const startDate = new Date(startDateStr);
                const endDate = new Date(endDateStr);
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                if (startDateStr === endDateStr) {
                    return `วันที่ ${startDate.toLocaleDateString('th-TH', options)}`;
                } else {
                    return `วันที่ ${startDate.toLocaleDateString('th-TH', options)} ถึง ${endDate.toLocaleDateString('th-TH', options)}`;
                }
            };
            
            const timeSlot = timeSlots[bookingData.timeSlot];
            const field = fieldData[selectedField];
            let fileSummaryHtml = '';

            if (bookingData.file) {
                 const fileIcon = bookingData.file.mimeType.includes('image') ? '🖼️' : '📄';
                 const fileLabel = bookingData.file.type === 'paymentSlip' ? 'สลิปการโอนเงิน' : 'บันทึกข้อความอนุมัติ';
                 fileSummaryHtml = `<p><strong>${fileLabel}:</strong> ${fileIcon} ${bookingData.file.name}</p>`;
            }


            const summary = `
                <h3 class="font-bold text-gray-800 mb-4">สรุปการจอง</h3>
                <div class="space-y-2">
                    <p><strong>ชื่อ-สกุล:</strong> ${bookingData.fullName}</p>
                    <p><strong>เบอร์โทรศัพท์:</strong> ${bookingData.phone}</p>
                    <p><strong>วันที่จอง:</strong> ${formatDateRange(bookingData.bookingStartDate, bookingData.bookingEndDate)}</p>
                    <p><strong>เวลา:</strong> ${timeSlot.label}</p>
                    <p><strong>ประเภทสนาม:</strong> <img src="${field.icon}" alt="${field.name}" class="inline-block w-6 h-6 mr-2">${field.name}</p>
                    <p><strong>สถานะ:</strong> ${bookingData.status}</p>
                    ${bookingData.equipment.length > 0 ? `<p><strong>อุปกรณ์:</strong> ${bookingData.equipment.join(', ')}</p>` : ''}
                    ${bookingData.staff.length > 0 ? `<p><strong>เจ้าหน้าที่:</strong> ${bookingData.staff.join(', ')}</p>` : ''}
                    ${bookingData.notes ? `<p><strong>หมายเหตุ:</strong> ${bookingData.notes}</p>` : ''}
                    ${fileSummaryHtml}
                </div>
            `;
            
            $('#bookingSummary').html(summary);
            $('#successPage').removeClass('hidden');
        }
    </script>
</body>
</html>
